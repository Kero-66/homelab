services:
  adguardhome:
    profiles:
      - network
      - all
    image: adguard/adguardhome:latest
    container_name: adguardhome
    user: "${PUID:-1000}:${PGID:-1000}"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ${CONFIG_DIR:-.}/adguard/conf:/opt/adguardhome/conf
      - ${CONFIG_DIR:-.}/adguard/work:/opt/adguardhome/work
    ports:
      - "${ADGUARD_DNS_PORT:-53}:53/udp"
      - "${ADGUARD_DNS_PORT:-53}:53/tcp"
    # Expose HTTP/HTTPS internally only; use Caddy as the external TLS terminator / reverse proxy
    expose:
      - "80"
      - "443"
    restart: "${RESTART_POLICY:-unless-stopped}"
    # NOTE: If you want DNS on the host network (recommended in some setups),
    # switch to `network_mode: "host"` and remove the ports mappings.
    healthcheck:
      test: ["CMD-SHELL", "wget -q -S --spider http://127.0.0.1:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      networking:
        ipv4_address: ${IP_ADGUARD:-172.30.0.3}

# You can override settings above in a top-level .env file or pass --env-file when running.

  caddy:
    profiles:
      - network
      - all
    image: caddy:2
    container_name: caddy
    user: "${PUID:-1000}:${PGID:-1000}"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - CADDY_EMAIL=${CADDY_EMAIL:-}
    volumes:
      - ${CONFIG_DIR:-.}/caddy/data:/data
      - ${CONFIG_DIR:-.}/caddy/config:/config
      - ${CONFIG_DIR:-.}/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
    # Bind Caddy ports. By default we listen on all interfaces so `localhost` works for both IPv4 and IPv6.
    # For local-only testing bind to loopback by setting the host IP prefix here (e.g. `127.0.0.1:${CADDY_HTTP_PORT:-80}:80`).
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
    restart: "${RESTART_POLICY:-unless-stopped}"
    depends_on:
      - adguardhome
    healthcheck:
      test: ["CMD-SHELL", "wget -q -S --spider http://127.0.0.1/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      networking:
        ipv4_address: ${IP_CADDY:-172.30.0.4}
      media_default: {}
      servarrnetwork: {}

networks:
  networking:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${NETWORK_SUBNET:-172.30.0.0/24}

  media_default:
    external: true
    name: media_default

  servarrnetwork:
    external: true
    name: servarrnetwork
