# Caddyfile — example configuration for this networking stack
# This configuration is tuned for local testing only (HTTP on loopback).
# To enable public HTTPS later, replace or extend this file with your real domains and set `CADDY_EMAIL`.

# Disable automatic HTTPS so Caddy does not try to obtain certificates for example domains
{
    auto_https off
    debug
}

# Jellyseerr prefers a dedicated host/subdomain — use the .localhost TLD for local testing
http://jellyseerr.localhost {
    reverse_proxy jellyseerr:5055
}

# Jellystat prefers a dedicated host/subdomain to avoid subpath limitations
http://jellystat.localhost {
    reverse_proxy jellystat:3000
}

# Beszel Hub monitoring dashboard
http://beszel.localhost {
    reverse_proxy beszel:8090 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }
}

# Infisical Secret Manager
http://infisical.localhost {
    reverse_proxy infisical-backend:8081 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }
}

# RSS Reader (DanB)
http://rss.localhost {
    reverse_proxy rss:80
}

# CommaFeed RSS Reader
http://commafeed.localhost {
    reverse_proxy commafeed:8082
}

# Netdata real-time monitoring
http://netdata.localhost {
    reverse_proxy netdata:19999 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }
}

# Glances cross-platform system monitoring
http://glances.localhost {
    reverse_proxy glances:61208 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }
}


# Local / testing configuration (HTTP only)

# Listen on localhost:80 for local testing (matches original behaviour).
# This avoids differences when browsers use an IP vs hostname.
http://localhost:80 {
    # Simple health check for monitoring
    handle_path /health {
        respond "OK" 200
    }

    # Path-based proxies for local testing of other services on the media stack
    # Redirect bare /sonarr (no trailing slash) to /sonarr/ so the
    # existing proxy rule for the subpath will match requests.
    @sonarr_exact {
        path /sonarr
    }
    redir @sonarr_exact /sonarr/ 308

    # Use `handle` (not `handle_path`) so the `/sonarr` prefix is preserved
    # when proxying. Sonarr is configured with `UrlBase=/sonarr`, so it
    # expects requests to include that prefix.
    handle /sonarr/* {
        reverse_proxy sonarr:8989
    }

    @radarr_exact {
        path /radarr
    }
    redir @radarr_exact /radarr/ 308

    # Preserve the /radarr prefix when proxying; Radarr is configured with UrlBase=/radarr
    handle /radarr/* {
        reverse_proxy radarr:7878
    }
    @sabnzbd_exact {
        path /sabnzbd
    }
    redir @sabnzbd_exact /sabnzbd/ 308

    # Preserve the /sabnzbd prefix when proxying; SABnzbd is configured with url_base=/sabnzbd
    handle /sabnzbd/* {
        reverse_proxy sabnzbd:8080
    }

    @prowlarr_exact {
        path /prowlarr
    }
    redir @prowlarr_exact /prowlarr/ 308

    # Preserve the /prowlarr prefix when proxying; Prowlarr is configured with UrlBase=/prowlarr
    handle /prowlarr/* {
        reverse_proxy prowlarr:9696 {
            header_up X-Forwarded-Prefix /prowlarr
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    @bazarr_exact {
        path /bazarr
    }
    redir @bazarr_exact /bazarr/ 308

    # Bazarr supports a base_url setting; preserve prefix when proxying
    handle /bazarr/* {
        reverse_proxy bazarr:6767 {
            header_up X-Forwarded-Prefix /bazarr
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    @qbittorrent_exact {
        path /qbittorrent
    }
    redir @qbittorrent_exact /qbittorrent/ 308

    # qBittorrent Web UI does not support a UrlBase; strip prefix when proxying
    handle_path /qbittorrent/* {
        reverse_proxy qbittorrent:8080
    }

    @jellyfin_exact {
        path /jellyfin
    }
    redir @jellyfin_exact /jellyfin/ 308

    # Jellyfin serves on port 8096; keep strip-prefix behavior so the app sees root paths
    handle_path /jellyfin/* {
        reverse_proxy jellyfin:8096 {
            # Let Jellyfin know it's behind a /jellyfin prefix so it generates
            # correct absolute URLs (and works from other devices).
            header_up X-Forwarded-Prefix /jellyfin
            header_up X-Forwarded-Proto {http.request.scheme}
            header_up X-Forwarded-Host {http.request.host}
        }
    }

    @jellyseerr_exact {
        path /jellyseerr
    }
    # Redirect any subpath-based requests to the recommended subdomain
    redir @jellyseerr_exact https://jellyseerr.localhost/ 308

    @jellyseerr_exact_slash {
        path /jellyseerr/
    }
    redir @jellyseerr_exact_slash https://jellyseerr.localhost/ 308

    @jellystat_exact {
        path /jellystat
    }
    redir @jellystat_exact http://jellystat.localhost/ 308

    @jellystat_exact_slash {
        path /jellystat/
    }
    redir @jellystat_exact_slash http://jellystat.localhost/ 308

    # Redirect any subpath under /jellystat/* to the dedicated subdomain
    handle_path /jellystat/* {
        redir http://jellystat.localhost{uri} 308
    }
    # Homepage path
    handle_path /homepage/* {
        reverse_proxy homepage:3000
    }

    # Cleanuparr
    @cleanuparr_exact {
        path /cleanuparr
    }
    redir @cleanuparr_exact /cleanuparr/ 308

    handle_path /cleanuparr/* {
        reverse_proxy cleanuparr:11011
    }

    # FileFlows
    @fileflows_exact {
        path /fileflows
    }
    redir @fileflows_exact /fileflows/ 308

    handle_path /fileflows/* {
        reverse_proxy fileflows:5000
    }

    # Adjust or add services as needed

    # AdGuard Home (disabled for now)
    # handle_path / {
    #     reverse_proxy adguardhome:3000
    # }

}
