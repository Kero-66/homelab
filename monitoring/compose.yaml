services:
  beszel:
    image: 'henrygd/beszel:latest'
    container_name: 'beszel'
    restart: ${RESTART_POLICY:-unless-stopped}
    mem_limit: 512m
    env_file:
      - .config/.credentials
      - .env
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - APP_URL=${APP_URL}
      - USER_EMAIL=${USER_EMAIL}
      - USER_PASSWORD=${USER_PASSWORD}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - ${BESZEL_PORT:-8090}:8090
    volumes:
      - ./beszel/hub/beszel_data:/beszel_data
      - ${DATA_DIR:-/data}:/data
    networks:
      servarrnetwork:
        ipv4_address: ${IP_BESZEL_HUB:-172.39.0.31}
    healthcheck:
      test: ["CMD", "/beszel", "health", "--url", "http://localhost:8090/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  beszel-agent:
    image: 'henrygd/beszel-agent:latest'
    container_name: 'beszel-agent'
    restart: ${RESTART_POLICY:-unless-stopped}
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./beszel/agent:/var/lib/beszel-agent
      - ${DATA_DIR:-/data}:/data:ro
    env_file:
      - .env
    environment:
      PORT: ${BESZEL_AGENT_PORT:-4567}
      KEY: '${BESZEL_AGENT_KEY:-}'
    healthcheck:
      test: ["CMD", "/agent", "health"]
      interval: 30s
      timeout: 10s
      retries: 3

  netdata:
    image: netdata/netdata:latest
    container_name: netdata
    hostname: ${HOSTNAME:-homelab}
    restart: ${RESTART_POLICY:-unless-stopped}
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./netdata/netdata.conf:/etc/netdata/netdata.conf:ro
      - ./netdata/lib:/var/lib/netdata
      - ./netdata/cache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    env_file:
      - .env
    environment:
      - TZ=${TZ}
    networks:
      servarrnetwork:
        ipv4_address: ${IP_NETDATA:-172.39.0.30}

  dockupdater:
    image: dockupdater/dockupdater:latest
    container_name: dockupdater
    restart: ${RESTART_POLICY:-unless-stopped}
    command: ["--interval", "604800", "--cleanup"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:z
    environment:
      - TZ=${TZ}
      - LOG_LEVEL=info
    networks:
      servarrnetwork:
        ipv4_address: ${IP_DOCKUPDATER:-172.39.0.32}

  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      - CONTAINERS=1      # Allow access to viewing containers
      - SERVICES=1        # Allow access to viewing services (Docker Swarm)
      - TASKS=1           # Allow access to viewing tasks (Docker Swarm)
      - POST=0            # Disallow any POST operations (read-only)
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - IMAGES=0
      - INFO=0
      - NETWORKS=0
      - NODES=0
      - PING=1            # Allow ping for healthcheck
      - PLUGINS=0
      - SECRETS=0
      - SYSTEM=0
      - VERSION=1         # Allow version check
      - VOLUMES=0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      servarrnetwork:
        ipv4_address: ${IP_DOCKER_SOCKET_PROXY:-172.39.0.33}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:2375/_ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  servarrnetwork:
    external: true
    name: servarrnetwork
