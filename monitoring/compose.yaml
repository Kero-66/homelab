services:
  beszel:
    image: 'henrygd/beszel:latest'
    container_name: 'beszel'
    restart: ${RESTART_POLICY:-unless-stopped}
    mem_limit: 512m
    env_file:
      - .config/.credentials
      - .env
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - APP_URL=${APP_URL}
      - USER_EMAIL=${USER_EMAIL}
      - USER_PASSWORD=${USER_PASSWORD}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - ${BESZEL_PORT:-8090}:8090
    volumes:
      - ./beszel/hub/beszel_data:/beszel_data
      - ${DATA_DIR:-/data}:/data
    networks:
      servarrnetwork:
        ipv4_address: ${IP_BESZEL_HUB:-172.39.0.31}
    healthcheck:
      test: ["CMD", "/beszel", "health", "--url", "http://localhost:8090/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  beszel-agent:
    image: 'henrygd/beszel-agent:latest'
    container_name: 'beszel-agent'
    restart: ${RESTART_POLICY:-unless-stopped}
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./beszel/agent:/var/lib/beszel-agent
      - ${DATA_DIR:-/data}:/data:ro
    env_file:
      - .env
    environment:
      PORT: ${BESZEL_AGENT_PORT:-4567}
      KEY: '${BESZEL_AGENT_KEY:-}'
    healthcheck:
      test: ["CMD", "/agent", "health"]
      interval: 30s
      timeout: 10s
      retries: 3

  netdata:
    image: netdata/netdata:latest
    container_name: netdata
    hostname: ${HOSTNAME:-homelab}
    restart: ${RESTART_POLICY:-unless-stopped}
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./netdata/netdata.conf:/etc/netdata/netdata.conf:ro
      - ./netdata/lib:/var/lib/netdata
      - ./netdata/cache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    env_file:
      - .env
    environment:
      - TZ=${TZ}
    networks:
      servarrnetwork:
        ipv4_address: ${IP_NETDATA:-172.39.0.30}

networks:
  servarrnetwork:
    external: true
    name: servarrnetwork
