# =============================================================================
# Jellyfin Stack - TrueNAS Scale
# =============================================================================
# Jellyfin media server + Jellyseerr requests + Jellystat analytics
#
# Storage layout:
#   Configs → /mnt/Fast/docker/jellyfin/             (NVMe pool - Docker configs)
#   Media   → /mnt/Data/media/                       (HDD pool - bulk storage)
#   DB      → /mnt/Fast/databases/jellystat/postgres/ (NVMe pool - Database)
#
# Secrets:
#   Managed by Infisical Agent → writes .env to /mnt/Fast/docker/jellyfin/.env
#   See ../infisical-agent/ for agent setup.
#
# =============================================================================

services:
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    mem_limit: 4g
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Australia/Brisbane
      # Intel N150 VAAPI hardware acceleration
      # iHD driver is bundled in jellyfin-ffmpeg but not on the system PATH
      - LIBVA_DRIVERS_PATH=/usr/lib/jellyfin-ffmpeg/lib/dri
      - LIBVA_DRIVER_NAME=iHD
    group_add:
      - "107"  # render group GID — required for /dev/dri/renderD128 access
      - "44"   # video group GID — required for /dev/dri/card0 access
    labels:
      - homepage.group=Media
      - homepage.name=Jellyfin
      - homepage.icon=jellyfin.png
      - homepage.href=http://jellyfin.home
      - homepage.description=Media server
      - homepage.widget.type=jellyfin
      - homepage.widget.url=http://jellyfin:8096
      - homepage.widget.key=${JELLYFIN_API_KEY}
    volumes:
      # Config on NVMe pool
      - /mnt/Fast/docker/jellyfin/config:/config
      # Media on HDD pool
      - /mnt/Data/media:/data
    # Hardware acceleration - Beelink Mini S Pro has Intel QuickSync
    devices:
      - /dev/dri:/dev/dri
    ports:
      - "8096:8096"
      - "8920:8920"
    healthcheck:
      test: curl -sf http://localhost:8096/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Australia/Brisbane
      - LOG_LEVEL=debug
    labels:
      - homepage.group=Media
      - homepage.name=Jellyseerr
      - homepage.icon=jellyseerr.png
      - homepage.href=http://jellyseerr.home
      - homepage.description=Media requests
      - homepage.widget.type=jellyseerr
      - homepage.widget.url=http://jellyseerr:5055
      - homepage.widget.key=${JELLYSEERR_API_KEY}
    volumes:
      - /mnt/Fast/docker/jellyseerr/config:/app/config
    ports:
      - "5055:5055"
    networks:
      - default
      - ix-arr-stack_default
    depends_on:
      - jellyfin
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  jellystat-db:
    image: postgres:15-alpine
    container_name: jellystat-db
    restart: unless-stopped
    env_file:
      - /mnt/Fast/docker/jellyfin/.env
    environment:
      - POSTGRES_DB=jfstat
      - TZ=Australia/Brisbane
    volumes:
      - /mnt/Fast/databases/jellystat/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  jellystat:
    image: cyfershepard/jellystat:latest
    container_name: jellystat
    restart: unless-stopped
    depends_on:
      jellystat-db:
        condition: service_healthy
    env_file:
      - /mnt/Fast/docker/jellyfin/.env
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Australia/Brisbane
      - POSTGRES_IP=jellystat-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=jfstat
    labels:
      - homepage.group=Media
      - homepage.name=Jellystat
      - homepage.icon=jellystat.png
      - homepage.href=http://jellystat.home
      - homepage.description=Jellyfin analytics
    volumes:
      - /mnt/Fast/docker/jellyfin/jellystat-backup:/app/backend/backup-data
    ports:
      - "3002:3000"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  ix-arr-stack_default:
    external: true
