# Dockhand GitOps Setup Guide

**Goal**: Manage TrueNAS containers via git-based deployments using Dockhand

**Status**: Testing with Caddy stack

---

## Architecture Overview

```
GitHub Repo (homelab)
    ↓ (git webhook or polling)
Dockhand on TrueNAS
    ↓ (docker API)
TrueNAS Custom Apps (containers)
```

**Benefits:**
- ✅ Infrastructure as Code - All changes tracked in git
- ✅ Automated deployments - Push to git, auto-deploy
- ✅ Rollback capability - Git history = deployment history
- ✅ Security - Secrets via Infisical, no hardcoded values
- ✅ Multi-environment - Can replicate to compute node later

---

## Prerequisites

### 1. Dockhand Access
- **Web UI**: http://192.168.20.22:<port> (check your TrueNAS deployment)
- **Authentication**: Configure OIDC/SSO or basic auth
- **User**: kero66 (UID 1000) should have access

### 2. Git Repository Setup
**Current structure:**
```
homelab/
├── truenas/stacks/
│   ├── caddy/
│   │   ├── compose.yaml
│   │   └── Caddyfile
│   ├── adguard-home/
│   ├── arr-stack/
│   └── ...
```

**GitOps-ready structure (proposed):**
```
homelab/
├── deployments/
│   └── truenas/
│       ├── caddy/
│       │   ├── docker-compose.yaml  # Symlink to ../../truenas/stacks/caddy/compose.yaml
│       │   └── .env                  # Generated by Infisical Agent
│       └── dockhand-config.yaml      # Dockhand GitOps configuration
```

---

## Setup Steps

### Step 1: Configure Git Repository in Dockhand

1. **Access Dockhand Web UI**
   - Navigate to Settings → Git Integration

2. **Add Repository**
   - **Repository URL**: `https://github.com/<your-username>/homelab.git`
   - **Branch**: `main`
   - **Auth Method**:
     - **Option A**: Deploy key (read-only, recommended)
     - **Option B**: Personal Access Token (stored in Infisical)

3. **Configure Auto-Sync**
   - **Watch Path**: `deployments/truenas/caddy/`
   - **Compose File**: `docker-compose.yaml`
   - **Sync Interval**: 60 seconds (or webhook-based)

4. **Environment Variables**
   - **Source**: File-based (`.env` generated by Infisical Agent)
   - **Path**: `/mnt/Fast/docker/caddy/.env` (if needed)

### Step 2: Prepare Caddy Stack for GitOps

#### 2.1 Create Deployment Directory
```bash
mkdir -p deployments/truenas/caddy
cd deployments/truenas/caddy
```

#### 2.2 Symlink Compose File
```bash
ln -s ../../../truenas/stacks/caddy/compose.yaml docker-compose.yaml
```

#### 2.3 Commit to Git
```bash
git add deployments/
git commit -m "feat(dockhand): add Caddy GitOps deployment structure"
git push origin main
```

### Step 3: Configure Dockhand Stack

1. **Create Stack in Dockhand**
   - Name: `caddy`
   - Source: Git Repository
   - Path: `deployments/truenas/caddy`
   - File: `docker-compose.yaml`

2. **Configure Volumes**
   - Ensure Dockhand can access `/mnt/Fast/docker/caddy/`
   - Verify Caddyfile is mounted correctly

3. **Configure Networks**
   - Ensure external networks are available:
     - `ix-jellyfin_default`
     - `ix-arr-stack_default`

4. **Enable Auto-Deploy**
   - Enable GitOps auto-sync
   - Set sync interval or webhook

### Step 4: Test GitOps Workflow

#### Test 1: Configuration Change (Non-breaking)
```bash
# 1. Make a comment change in compose.yaml
cd truenas/stacks/caddy
echo "# Test GitOps deployment - $(date)" >> compose.yaml

# 2. Commit and push
git add compose.yaml
git commit -m "test(caddy): verify GitOps auto-deployment"
git push origin main

# 3. Watch Dockhand logs for sync
# Should see: "Stack 'caddy' updated from git"

# 4. Verify deployment
curl -I http://192.168.20.22
# Should return HTTP 200 with no interruption
```

#### Test 2: Image Update
```bash
# 1. Update Caddy image tag
sed -i 's/caddy:latest/caddy:2.7-alpine/' truenas/stacks/caddy/compose.yaml

# 2. Commit and push
git add compose.yaml
git commit -m "feat(caddy): update to alpine image for smaller footprint"
git push origin main

# 3. Dockhand should:
#    - Detect change
#    - Pull new image
#    - Recreate container
#    - Verify health check passes
```

#### Test 3: Rollback
```bash
# If deployment fails, rollback via git
git revert HEAD
git push origin main

# Dockhand should auto-deploy previous working version
```

---

## Security Considerations

### 1. Git Repository Access

**Option A: Deploy Key (Recommended)**
```bash
# Generate deploy key (read-only)
ssh-keygen -t ed25519 -C "dockhand@truenas" -f ~/.ssh/dockhand_deploy_key

# Add public key to GitHub repo settings (read-only)
# Configure in Dockhand: Settings → Git → SSH Key
```

**Option B: Personal Access Token**
```bash
# Create PAT in GitHub with repo:read scope
# Store in Infisical at /dockhand/github_pat
# Configure in Dockhand via environment variable
```

### 2. Secrets Management

**Current**: Infisical Agent → `/mnt/Fast/docker/<stack>/.env`

**With Dockhand**:
- Dockhand reads compose.yaml from git
- Infisical Agent continues to render `.env` files
- Compose references `.env` via `env_file: /mnt/Fast/docker/caddy/.env`

**Important**: Never commit `.env` files or secrets to git!

### 3. Webhook Security

If using webhooks instead of polling:
```yaml
# GitHub webhook configuration
URL: https://dockhand.home/api/webhooks/github
Secret: <stored in Infisical>
Events: push (to main branch only)
```

---

## Monitoring & Validation

### Dockhand Logs
```bash
# View Dockhand sync logs
ssh kero66@192.168.20.22
docker logs -f dockhand

# Should show:
# [GitOps] Syncing repository: homelab
# [GitOps] Detected changes in: deployments/truenas/caddy
# [GitOps] Deploying stack: caddy
# [GitOps] Stack 'caddy' deployed successfully
```

### Stack Health
```bash
# Check Caddy container status
curl http://192.168.20.22:2019/config/
# Should return Caddy admin API response

# Check reverse proxy
curl -I http://jellyfin.home
# Should return HTTP 200 or 302
```

### Git Sync Status
- **Dockhand UI**: View last sync time, commit hash
- **Expected**: Sync within 60 seconds of push
- **Alert**: If sync fails, Dockhand should log error

---

## Troubleshooting

### Issue: Dockhand Can't Access Git Repo

**Symptom**: "Authentication failed" in logs

**Solution**:
```bash
# Verify deploy key is added to GitHub
# Verify Dockhand has correct SSH key configured
# Test SSH access manually:
ssh -i ~/.ssh/dockhand_deploy_key git@github.com
```

### Issue: Compose File Not Found

**Symptom**: "No such file: docker-compose.yaml"

**Solution**:
```bash
# Verify symlink is correct
ls -la deployments/truenas/caddy/docker-compose.yaml

# Should show:
# lrwxrwxrwx ... docker-compose.yaml -> ../../../truenas/stacks/caddy/compose.yaml
```

### Issue: Container Won't Start After GitOps Deploy

**Symptom**: Container exits immediately after deployment

**Solution**:
```bash
# Check Dockhand logs for detailed error
docker logs dockhand | grep -A10 "stack: caddy"

# Verify volumes are accessible
ls -la /mnt/Fast/docker/caddy/Caddyfile

# Manually test compose file
cd truenas/stacks/caddy
docker compose config  # Validates syntax
```

### Issue: External Networks Not Found

**Symptom**: "network ix-jellyfin_default not found"

**Solution**:
```bash
# Verify networks exist
docker network ls | grep ix-

# If missing, ensure other stacks are deployed first
# Networks are created by TrueNAS when deploying apps
```

---

## Migration Path for Other Stacks

Once Caddy GitOps is working, migrate other stacks:

### Priority Order:
1. ✅ **Caddy** (testing now)
2. **AdGuard Home** (simple, no external networks)
3. **Jellyfin** (single stack, well-tested)
4. **Arr-stack** (complex, multiple services)
5. **Downloaders** (depends on arr-stack network)
6. **Tailscale** (network complexity, test last)

### Migration Template:
```bash
# For each stack:
mkdir -p deployments/truenas/<stack-name>
cd deployments/truenas/<stack-name>
ln -s ../../../truenas/stacks/<stack-name>/compose.yaml docker-compose.yaml
git add .
git commit -m "feat(dockhand): add <stack-name> GitOps deployment"
git push

# Configure in Dockhand UI
# Test deployment
# Verify functionality
```

---

## Future Enhancements

### 1. Multi-Environment Support
```
deployments/
├── truenas/      # Production
└── compute-node/  # Future separate node
```

### 2. Pre-Deploy Validation
- Add GitHub Actions to validate compose files
- Run `docker compose config` in CI
- Prevent invalid configs from being deployed

### 3. Automated Testing
- Health check validation
- Integration tests after deployment
- Rollback on failed health checks

### 4. Notifications
- Slack/Discord webhook on deployment success/failure
- Email alerts for critical stacks
- Prometheus metrics for deployment tracking

---

## Reference Links

- [Dockhand Documentation](https://dockhand.pro/)
- [Dockhand GitOps Features](https://www.virtualizationhowto.com/2026/01/why-dockhand-is-one-of-the-best-docker-management-tools-for-secure-operations/)
- [TrueNAS Custom Apps](https://www.truenas.com/docs/truenasapps/usingcustomapp/)

---

**Status**: Ready for testing with Caddy
**Next Steps**:
1. Access Dockhand UI
2. Configure git repository
3. Test deployment workflow
4. Document results in SESSION_NOTES.md
